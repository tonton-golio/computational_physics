@import "tailwindcss";

@custom-variant dark (&:where(:root[data-theme="dark"], :root[data-theme="dark"] *));

:root {
  --background: #edf0f5;
  --foreground: #1a2235;
  --surface-1: #f5f6f9;
  --surface-2: #e4e8f0;
  --surface-3: #d8dde8;
  --border: #d0d8e8;
  --border-strong: #bcc6da;
  --text-muted: #4a5a72;
  --text-soft: #657488;
  --text-strong: #1a2235;
  --accent: #2d56be;
  --accent-strong: #1c4290;
  --danger-surface: #f5edef;
  --danger-border: #e0b3be;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #070b14;
    --foreground: #e8edf8;
    --surface-1: #0d1322;
    --surface-2: #101a2d;
    --surface-3: #14233f;
    --border: #1e3250;
    --border-strong: #2c4166;
    --text-muted: #a5b5d0;
    --text-soft: #7f94b6;
    --text-strong: #f4f7ff;
    --accent: #7bb0ff;
    --accent-strong: #9dc2ff;
    --danger-surface: #1a1122;
    --danger-border: #55314b;
  }
}

:root[data-theme="light"] {
  --background: #edf0f5;
  --foreground: #1a2235;
  --surface-1: #f5f6f9;
  --surface-2: #e4e8f0;
  --surface-3: #d8dde8;
  --border: #d0d8e8;
  --border-strong: #bcc6da;
  --text-muted: #4a5a72;
  --text-soft: #657488;
  --text-strong: #1a2235;
  --accent: #2d56be;
  --accent-strong: #1c4290;
  --danger-surface: #f5edef;
  --danger-border: #e0b3be;
}

:root[data-theme="dark"] {
  --background: #070b14;
  --foreground: #e8edf8;
  --surface-1: #0d1322;
  --surface-2: #101a2d;
  --surface-3: #14233f;
  --border: #1e3250;
  --border-strong: #2c4166;
  --text-muted: #a5b5d0;
  --text-soft: #7f94b6;
  --text-strong: #f4f7ff;
  --accent: #7bb0ff;
  --accent-strong: #9dc2ff;
  --danger-surface: #1a1122;
  --danger-border: #55314b;
}

body {
  background-color: var(--background);
  background-image: radial-gradient(circle at 20% 20%, rgba(45,86,190,0.25), transparent 45%),
                    radial-gradient(circle at 80% 70%, rgba(139,92,216,0.20), transparent 50%) !important;
  background-attachment: fixed;
  color: var(--foreground);
  font-family: var(--font-geist-sans), Inter, system-ui, -apple-system, sans-serif;
}

:root[data-theme="dark"] body {
  background-image: radial-gradient(circle at 20% 20%, rgba(56,189,248,0.08), transparent 35%),
                    radial-gradient(circle at 80% 70%, rgba(168,85,247,0.09), transparent 40%) !important;
}

@media (prefers-color-scheme: dark) {
  :root:not([data-theme="light"]) body {
    background-image: radial-gradient(circle at 20% 20%, rgba(56,189,248,0.08), transparent 35%),
                      radial-gradient(circle at 80% 70%, rgba(168,85,247,0.09), transparent 40%) !important;
  }
}

.markdown-content h1,
.markdown-content h2,
.markdown-content h3 {
  color: var(--text-strong);
}

.markdown-content p,
.markdown-content li {
  color: var(--text-muted);
}

.markdown-content a {
  color: var(--accent);
}

.markdown-content pre {
  background: var(--surface-2) !important;
  color: var(--foreground) !important;
  border: 1px solid var(--border-strong);
}

.markdown-content code {
  color: var(--accent-strong);
}

.markdown-content table {
  background: var(--surface-2) !important;
  border-color: var(--border-strong);
}

.markdown-content th,
.markdown-content td {
  border-color: var(--border-strong) !important;
  color: var(--text-muted) !important;
}

/* Collapsible sidebar grid */
.sidebar-grid {
  transition: grid-template-columns 300ms ease-in-out, gap 300ms ease-in-out;
}

@media (min-width: 1024px) {
  .sidebar-grid[data-collapsed="false"] {
    grid-template-columns: 320px minmax(0, 1fr);
    gap: 20px;
  }
  .sidebar-grid[data-collapsed="true"] {
    grid-template-columns: 0px minmax(0, 1fr);
    gap: 0px;
  }
}

/* Fullscreen simulation background */
:fullscreen {
  background-color: var(--surface-1);
}
:-webkit-full-screen {
  background-color: var(--surface-1);
}
.sim-fake-fullscreen {
  background-color: var(--surface-1);
}

/* ── Fullscreen simulation layout ─────────────────────────────────── */

/* Wrapper fills the fullscreen container */
.sim-fs-content {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

/*
 * Simulation root becomes a flex column pushed to the bottom.
 * Visual children (with canvas/video) are pulled out via position:absolute
 * so they fill the entire screen behind the flow content.
 */
.sim-fs-content > * {
  width: 100%;
  height: 100%;
  display: flex !important;
  flex-direction: column;
  justify-content: flex-end;
  align-items: flex-start;
  gap: 8px !important;
  padding: 12px;
  position: relative;
  pointer-events: none;
}

/* ── Main visualization (SimulationMain): fill viewport ── */
.sim-fs-main {
  position: absolute;
  top: 44px;
  left: 0;
  width: 100%;
  height: calc(100% - 44px);
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 0;
  pointer-events: auto;
  border: none;
  border-radius: 0;
  padding: 0;
  background: transparent;
  backdrop-filter: none;
}

/* Contain mode: prevent square / aspect-ratio canvases from overflowing */
.sim-fs-main[data-fs-scale="contain"] > * {
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: 100%;
}

/* Scale p5.js / 2D canvases to fill their main container.
   Three.js canvases have data-engine and resize automatically. */
.sim-fs-main canvas:not([data-engine]) {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* ── Fallback: non-hybrid visual children (canvas/video/svg without SimulationMain) ── */
/* Excludes elements with explicit data-fs-role (e.g. chart overlays) or data-sim-slot (e.g. aux) */
.sim-fs-content > * > *:has(canvas):not(.sim-fs-main):not([data-fs-role]):not([data-sim-slot]),
.sim-fs-content > * > *:has(video):not(.sim-fs-main):not([data-fs-role]):not([data-sim-slot]),
.sim-fs-content > * > *:has(> svg[viewBox]):not(.sim-fs-main):not([data-fs-role]):not([data-sim-slot]) {
  position: absolute;
  top: 44px;
  left: 0;
  width: 100%;
  height: calc(100% - 44px);
  z-index: 0;
  border-radius: 0;
  border: none;
  overflow: hidden;
  pointer-events: auto;
}

/* Scale inline SVGs to fill their fallback container */
.sim-fs-content > * > *:has(> svg[viewBox]):not(.sim-fs-main) > svg {
  width: 100%;
  height: 100%;
}

/* ── Grid/flex wrappers between sim root and role elements: transparent ── */
.sim-fs-content > * > *:not([data-fs-role]):not([data-sim-slot]):not(.sim-fs-main):not(:has(canvas)):not(:has(video)):not(:has(> svg[viewBox])):not(:has([data-sim-slot])) {
  position: relative;
  z-index: 5;
  max-width: min(360px, calc(100% - 24px));
  background: color-mix(in srgb, var(--surface-1) 80%, transparent);
  backdrop-filter: blur(12px);
  border-radius: 12px;
  border: 1px solid var(--border-strong);
  padding: 12px;
  pointer-events: auto;
  flex-shrink: 0;
}

/* Wrapper divs that contain chart/main children become transparent in fullscreen */
.sim-fs-content > * > *:has([data-fs-role]):not([data-fs-role]):not(.sim-fs-main) {
  display: contents;
}

/* ── Controls (Card, SimulationPanel): overlay bottom-left ── */
/* backdrop-filter moved to ::before so it doesn't create a containing block
   (which would trap position:fixed children like charts) */
.sim-fs-content [data-fs-role="controls"] {
  position: relative;
  z-index: 5;
  max-width: min(360px, calc(100% - 24px));
  background: transparent;
  backdrop-filter: none;
  pointer-events: auto;
  flex-shrink: 0;
}

/* Glass effect via pseudo-element — provides visual backdrop without
   creating a containing block for position:fixed children */
.sim-fs-content [data-fs-role="controls"]::before {
  content: "";
  position: absolute;
  inset: 0;
  background: color-mix(in srgb, var(--surface-1) 80%, transparent);
  backdrop-filter: blur(12px);
  border-radius: inherit;
  z-index: -1;
  pointer-events: none;
}

/* Charts inside controls escape to viewport via position:fixed */
.sim-fs-content [data-fs-role="controls"] [data-fs-role="chart"] {
  position: fixed;
}

/* Promoted charts (sim-fs-main) inside controls also escape */
.sim-fs-content [data-fs-role="controls"] .sim-fs-main {
  position: fixed;
}

/* Nested controls: outer panel becomes transparent when inner
   SimulationControls handles controls role */
.sim-fs-content [data-fs-role="controls"]:has([data-fs-role="controls"]) {
  display: contents;
}

/* Hide glass effect on the transparent outer panel */
.sim-fs-content [data-fs-role="controls"]:has([data-fs-role="controls"])::before {
  display: none;
}

/* ── Charts (CanvasChart): base overlay style ── */
.sim-fs-content [data-fs-role="chart"] {
  position: absolute;
  z-index: 6;
  width: min(340px, 25vw);
  height: min(200px, 25vh);
  background: color-mix(in srgb, var(--surface-1) 80%, transparent);
  backdrop-filter: blur(12px);
  border-radius: 12px;
  border: 1px solid var(--border-strong);
  padding: 8px;
  pointer-events: auto;
}

/* Chart stacking: positioned by data-fs-chart-index (set by JS) */
.sim-fs-content [data-fs-role="chart"][data-fs-chart-index="0"] {
  bottom: 12px;
  right: 12px;
}
.sim-fs-content [data-fs-role="chart"][data-fs-chart-index="1"] {
  bottom: calc(12px + min(200px, 25vh) + 8px);
  right: 12px;
}
.sim-fs-content [data-fs-role="chart"][data-fs-chart-index="2"] {
  bottom: 12px;
  right: calc(12px + min(340px, 25vw) + 8px);
}
.sim-fs-content [data-fs-role="chart"][data-fs-chart-index="3"] {
  bottom: calc(12px + min(200px, 25vh) + 8px);
  right: calc(12px + min(340px, 25vw) + 8px);
}

/* Fallback: charts without an index (JS not yet run) stack bottom-right */
.sim-fs-content [data-fs-role="chart"]:not([data-fs-chart-index]) {
  bottom: 12px;
  right: 12px;
}

/* ── Fullscreen title overlay (legacy — from SimulationHost) ── */
.sim-fs-title {
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 10;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-strong);
  background: color-mix(in srgb, var(--surface-1) 70%, transparent);
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-strong);
  border-radius: 8px;
  padding: 6px 16px;
  white-space: nowrap;
  pointer-events: none;
}

/* ── Fullscreen title — top center (from SimulationPanel slot) ── */
.sim-fs-title-center {
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-strong);
  background: color-mix(in srgb, var(--surface-1) 70%, transparent);
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-strong);
  border-radius: 8px;
  padding: 6px 16px;
  white-space: nowrap;
  pointer-events: none;
}

/* ── Semantic slot glass boxes — fullscreen left stack ── */

/* Shared base for all left-stack slots */
.sim-fs-content [data-sim-slot="caption"],
.sim-fs-content [data-sim-slot="settings"],
.sim-fs-content [data-sim-slot="config"],
.sim-fs-content [data-sim-slot="results"] {
  position: relative;
  z-index: 5;
  background: transparent;
  backdrop-filter: none;
  border-radius: 12px;
  border: 1px solid var(--border-strong);
  padding: 12px;
  pointer-events: auto;
  flex-shrink: 0;
}

/* Settings: variable width (buttons/toggles don't need full width) */
.sim-fs-content [data-sim-slot="settings"] {
  max-width: min(510px, 37.5vw);
}

/* Caption, config, results: fixed width matching aux container */
.sim-fs-content [data-sim-slot="caption"],
.sim-fs-content [data-sim-slot="config"],
.sim-fs-content [data-sim-slot="results"] {
  width: min(510px, 37.5vw);
}

/* Glass via pseudo to avoid containing block issues */
.sim-fs-content [data-sim-slot="caption"]::before,
.sim-fs-content [data-sim-slot="settings"]::before,
.sim-fs-content [data-sim-slot="config"]::before,
.sim-fs-content [data-sim-slot="results"]::before {
  content: "";
  position: absolute;
  inset: 0;
  background: color-mix(in srgb, var(--surface-1) 80%, transparent);
  backdrop-filter: blur(12px);
  border-radius: inherit;
  z-index: -1;
  pointer-events: none;
}

/* ── Aux — right side overlay in fullscreen ── */
.sim-fs-content [data-sim-slot="aux"] {
  position: absolute;
  right: 12px;
  bottom: 12px;
  z-index: 6;
  width: min(510px, 37.5vw);
  max-height: 80vh;
  overflow-y: auto;
  background: color-mix(in srgb, var(--surface-1) 80%, transparent);
  backdrop-filter: blur(12px);
  border-radius: 12px;
  border: 1px solid var(--border-strong);
  padding: 8px;
  pointer-events: auto;
}

/* ── Wrapper dissolution: grids containing slots dissolve in fullscreen ── */
.sim-fs-content > * > *:has([data-sim-slot]):not([data-sim-slot]):not(.sim-fs-main) {
  display: contents;
}

/* ── Outer panel transparent when it contains new-style slots ── */
.sim-fs-content [data-fs-role="controls"]:has([data-sim-slot]) {
  display: contents;
}
.sim-fs-content [data-fs-role="controls"]:has([data-sim-slot])::before {
  display: none;
}

/* Shimmer animation for loading skeletons */
@keyframes shimmer {
  0% {
    transform: translateX(-100%);
  }
  100% {
    transform: translateX(100%);
  }
}
